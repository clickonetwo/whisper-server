function e(e){return e&&e.__esModule?e.default:e}var t=globalThis,n={},r={},s=t.parcelRequire94c2;null==s&&((s=function(e){if(e in n)return n[e].exports;if(e in r){var t=r[e];delete r[e];var s={id:e,exports:{}};return n[e]=s,t.call(s.exports,s,s.exports),s.exports}var i=Error("Cannot find module '"+e+"'");throw i.code="MODULE_NOT_FOUND",i}).register=function(e,t){r[e]=t},t.parcelRequire94c2=s),s.register;var i=s("iM5HV"),o=s("fYo6y"),a=s("b2S2j"),i=s("iM5HV"),o=s("fYo6y"),l=s("3gKTU"),c=s("2Efon"),u=s("b8C0m");const d=e(l).get("conversationId")||"",f=e(l).get("conversationName")||"",h=e(l).get("whispererName")||"",p=e(l).get("clientId")||"";let g=e(l).get("clientName")||"";d&&h&&p&&f||(window.location.href="/subscribe404.html");const v=new u.Realtime.Promise({clientId:p,authUrl:"/api/v2/listenTokenRequest",echoMessages:!1});function x(t){let[n,r]=(0,o.useState)(t.name);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("h1",{children:"Advisory"}),(0,i.jsx)("p",{children:"By entering your name below, you are agreeing to receive messages sent by another user (the Whisperer) in a remote location.  Your name and agreement will be remembered in this browser for all conversations with all Whisperers until you clear your browser's cookies for this site."}),(0,i.jsx)("h2",{children:"Please provide your name to the Whisperer:"}),(0,i.jsx)("input",{name:"listenerName",id:"listenerName",type:"text",value:n.valueOf(),onChange:function(e){r(g=e.target.value)}}),(0,i.jsx)("button",{id:"updateButton",type:"button",onClick:function(){t.setName(g),e(l).set("clientName",g,{expires:365})},children:"Agree & Save Name"})]})}function m(e){return console.log("Closing all connections"),v.close(),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("h1",{children:["Disconnected from conversation “",f,"”"]}),(0,i.jsx)("p",{children:e.message}),(0,i.jsxs)("p",{children:["You can close this window or ",(0,i.jsx)("a",{href:window.location.href,children:"click here to listen again"}),"."]})]})}function w(e){var t;let[n,r]=(0,o.useState)("initial"),{channel:s}=(0,c.useChannel)(`${d}:control`,t=>(function(e,t,n,r){let s=p.toUpperCase(),i=e.name.toUpperCase();if(i!=s&&"ALL"!=i)return;let o=function(e){let t=e.split("|"),n=function(e){switch(e){case"-20":return"whisperOffer";case"-21":return"listenRequest";case"-22":return"listenAuthYes";case"-23":return"listenAuthNo";case"-24":return"joining";case"-25":return"dropping";case"-26":return"listenOffer";case"-40":return"requestReread";default:return}}(t[0]);if(7==t.length&&n)return{offset:n,conversationId:t[1],conversationName:t[2],clientId:t[3],profileId:t[4],username:t[5],contentId:t[6]}}(e.data);if(!o){console.error(`Ignoring invalid control packet: ${e.data}`),n("Ignoring an invalid packet; see log for details");return}switch(o.offset){case"dropping":console.log("Whisperer is dropping this client"),r(`${h} has stopped whispering.`);break;case"listenAuthYes":if(console.log(`Received content id: ${o.contentId}`),o.contentId.match(/^[A-Za-z0-9-]{36}$/)){console.log("Joining the conversation");let e=y("joining"),r=`${e}|${d}|${o.conversationName}|${p}|${p}|${g}|`;t.publish(o.clientId,r).then(),n(o.contentId)}else console.error(`Invalid content id: ${o.contentId}.  Please report a bug!`),R(t),r("There was a communication error (invalid channel id).  Please report a bug.");break;case"listenAuthNo":console.log("Whisperer refused listener presence"),R(t),r(`${h} has refused to let you join this conversation`);break;case"whisperOffer":console.log("Received Whisper offer, sending request"),n("requesting"),console.log(`Received whisper offer from ${o.clientId}, sending listen request`);let a=y("listenRequest"),l=`${a}|${d}|${o.conversationName}|${p}|${p}|${g}|`;t.publish(o.clientId,l).then()}})(t,s,r,e.exit));return(t=()=>R(s),(0,o.useEffect)(()=>{let e=e=>(e.preventDefault(),console.log("Running beforeunload hook..."),t(),e.returnValue="Are you sure you want to exit?");return window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e)}},[]),k(()=>(function(e){console.log("Sending listen offer");let t=`${y("listenOffer")}|${d}||${p}|${p}||`;e.publish("whisperer",t).then()})(s),"initialOffer",1),n.match(/^[A-Za-z0-9-]{36}$/))?(0,i.jsx)(j,{contentId:n,reread:()=>(function(e){if(I)return;console.log("Requesting resend of live text..."),I=!0;let t=`${y("requestReread")}|live`;e.publish("whisperer",t).then()})(s)}):(0,i.jsx)($,{status:n})}function $(e){let t;switch(e.status){case"initial":t="Starting to connect...";break;case"requesting":t="Requesting permission to join the conversation...";break;default:t=`Something has gone wrong (invalid status ${e.status}).  Please try refreshing this window.`}return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("h1",{children:["Conversation “",f,"” with ",h]}),(0,i.jsx)("form",{children:(0,i.jsx)("textarea",{rows:1,id:"status",value:t})})]})}function j(e){let[t,n]=(0,o.useState)({live:"",past:""});return(0,c.useChannel)(`${d}:${e.contentId}`,t=>(function(e,t,n){let r=p.toUpperCase(),s=e.name.toUpperCase();if(s!=r&&"ALL"!=s)return;let i=function(e){let t=e.match(/^(-?[0-9]+)|(.*)$/);if(!t||3!=t.length)return;let n=parseInt(t[1]);if(!isNaN(n))return{isDiff:n>=-1,offset:function(e){switch(e){case -1:return"newline";case -2:return"pastText";case -3:return"liveText";case -4:return"startReread";case -6:return"clearHistory";case -7:return"playSound";case -8:return"playSpeech";default:return}}(n)||n,text:t[2]}}(e.data);if(!i){console.error(`Ignoring invalid content chunk: ${e.data}`);return}if(I)"startReread"===i.offset?(console.log("Received reset acknowledgement from whisperer, resetting live text"),t(e=>({live:"",past:e.past}))):i.isDiff?console.log("Ignoring diff chunk because a read is in progress"):"pastText"===i.offset?console.log("Received unexpected past line chunk, ignoring it"):"liveText"===i.offset&&(console.log("Receive live text chunk, update is over"),I=!1,t(e=>({live:i.text,past:e.past})));else if(i.isDiff){if(0===i.offset)t(e=>({live:i.text,past:e.past}));else if("newline"===i.offset)console.log("Prepending live text to past line"),t(e=>({live:"",past:e.live+"\n"+e.past}));else{let e=i.offset;t(t=>e>t.live.length?(n(),t):{live:t.live.substring(0,e)+i.text,past:t.past})}}else"string"==typeof i.offset?console.warn(`Ignoring ${i.offset} content request for: ${i.text}`):console.error(`Unimplemented content chunk with offset ${i.offset} text: ${i.text}`)})(t,n,e.reread)),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("h1",{children:["Conversation “",f,"” with ",h]}),(0,i.jsx)("form",{children:(0,i.jsx)(b,{text:t,reread:e.reread})})]})}function b(e){return k(e.reread,"initialRead",1),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("textarea",{id:"liveText",rows:10,value:e.text.live}),(0,i.jsx)("textarea",{id:"pastText",rows:30,readOnly:!0,value:e.text.past})]})}let I=!1;function y(e){switch(e){case"whisperOffer":return"-20";case"listenRequest":return"-21";case"listenAuthYes":return"-22";case"listenAuthNo":return"-23";case"joining":return"-24";case"dropping":return"-25";case"listenOffer":return"-26";case"requestReread":return"-40";default:return}}function R(e){console.log("Sending drop message");let t=`${y("dropping")}|||${p}|||`;e.publish("whisperer",t).then()}const N={};function k(e,t,n){let r=N[t]||0;r<n&&(N[t]=r+1,e())}(0,a.createRoot)(document.getElementById("root")).render((0,i.jsx)(o.StrictMode,{children:(0,i.jsx)(function(){let[e,t]=(0,o.useState)(""),[n,r]=(0,o.useState)(g);return n?e?(0,i.jsx)(m,{message:e}):(0,i.jsx)(c.AblyProvider,{client:v,children:(0,i.jsx)(w,{exit:e=>t(e)})}):(0,i.jsx)(x,{name:n,setName:r})},{})}));